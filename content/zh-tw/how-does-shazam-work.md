---
title: 聽歌識曲的原理
date: 2025-03-05
tags: ['media-processing']
authors: ['Maya']
ai: True
draft: False
---
在進行深入的討論之前, 我們需要先了解一些什麼是音頻. 首先, 聲音是波, 那麼起決定性作用的就是頻率和振幅, 其中頻率決定聲音的音調, 振幅決定聲音的響度. 人耳一般能夠聽到**20Hz~20kHz**的聲音.

## 頻率

這也就是為什麼我們通常使用44.1kHz採樣的音頻, 如果你的採樣率小於等於頻率的二倍, 就無法很好地表示出當前的正弦波. 如果你想很好地將音樂從模擬信號轉化為數字信號, 你至少需要大於40kHz的採樣率, 一般的工業標準是2.2倍頻率預留一些空間, 也就是44kHz.

HIFI公司例如索尼選擇44.1kHz因為它高於40kHz並且兼容NTSC和PAL. 其他的48kHz, 96kHz, 192kHz也是可以的, 但是如果你不是專業人士一般沒法聽出區別, 同時高採樣率帶來的問題是文件會佔用更多的空間.

## PCM
Pulse Coded Modulation是常見的音頻存儲格式, 我們使用的音頻設備一般會直接播放這種音頻, 比如一個AAC編碼的音樂在解碼後產生的PCM數據會送往音頻設備的驅動程序進行播放. 其中每一組數據中存放每個聲道的一個採樣, 一個採樣可以是16位整數或者32位浮點數等.
![](pcm-stereo-sample.png)

## 傅里葉變換

那麼我們如何通過一堆採樣來獲取原始音頻的頻率呢? 對於模擬信號來說, 我們可以通過**傅里葉變換**(Fourier Transform)將關於時間的函數轉化為關於頻率的函數. 換句話說, 你可以對音樂施加傅里葉變換來獲得音樂中所有頻率和它們的強度.

通俗來講, 傅里葉變換就是將某一個時刻的音頻波分解為**多個不同振幅不同頻率的標準波**.

但是我們的問題是, 現在只有數字信號, 而不是模擬信號. 幸好還有**離散傅里葉變換**(Discrete Fourier Transform).

> [!NOTE]
> 離散傅里葉變換只能應用在單一通道上, 如果你有空間音頻那麼你就需要將它轉化成一個單通道的音頻

如下是離散傅里葉變換的公式:

$$
X(n)=\sum^{N-1}_{k=0}x[k]e^{-j(2\pi kn/N)}
$$

其中
- N代表窗口的大小, 指的是當前我們有多少的採樣暴露在當前窗口中.
- X(n)表示第n個桶的頻率組.
- x(k)表示音頻信號的第k個採樣.

例如, 我們處理一個4096個採樣的窗口的時候, 這個公式需要計算4096次. 其中
- n=0時計算第0個桶的頻率組
- n=1時計算第1個桶的頻率組
- ...

注意這裡計算的結果是頻率組而不是頻率, 因為一個DFT給出的結果是離散的頻譜.
一個頻率組是DFT能夠計算的最小單位.
其中我們分為4096個桶, 每個桶就可以負責約10.7Hz的頻率段.
比如第一個桶中的頻率組是0~5.38Hz(第一個桶是特殊的), 第二個是5.38~16.15Hz, 這就代表當前DFT無法區分出一個頻率組內相差10.77Hz以內的頻率, 導致**頻率解析率**的降低. 如果說兩個音符的頻率在這個同一範圍之內, 我們就無法區分它們.

我們可以通過提高窗口的大小來提高音頻解析率, 但是同時也會增大計算開銷.

但是使用離散傅里葉變換生成頻譜圖還有一個坑, 如果我們的採樣率是44.1kHz, 因為高於44.1kHz一半的頻率都無法正確表示, 當我們的頻率為$x+\frac{1}{2}S$的時候變換的結果與$x$相同(其中x為當前頻率, S為採樣率), 所以進行變換的時候我們只需要關注一半的結果即可, 也就是0~22.05kHz的頻譜.

### 窗口函數

因為DFT要求我們對音頻進行劃分, 如果我們想要分析某一個很短的時間段內的頻譜, 就需要一個窗口函數來對音頻採樣進行劃分. 

音頻劃分會導致**頻譜洩露**, 由於使用窗口劃分函數導致真正的頻率的能量洩露到其他頻率, 比如你的採樣率是 $f_S$, 窗口大小是$N$, 那麼如果你的頻率不是$\frac{f_S}{N}$的整數倍, 就會產生頻譜洩露. 你可以通過選擇更恰當的窗口函數來減小頻譜洩露的影響, 但是你無法完全避免它.

### FFT

直接進行離散傅里葉變換的時間複雜度是$O(N^2)$, 我們可以通過使用分治法來加速這一過程, 使用快速傅里葉變換的時間複雜度僅有$O(NlogN)$. 但是這樣需要輸入的長度是2的次幂, 如果原始數據的長度不是2的次幂我們可以通過填充0來調整長度.

## 聽歌識曲

### 頻譜過濾
因為聽歌識曲需要容忍噪音, 我們需要對輸入音頻進行過濾, 提取出響度最大的音頻. 但是這裡我們並不能直接對於每個時間段求出前X大的頻率, 因為人耳對低頻率和高頻率的音頻更不敏感, 所以很多音樂在發行之前會先進行預處理增強低頻, 如果這麼做的話會讓兩個鼓點相似的音樂在頻譜圖上十分相似.

一個比較好的解決方案就是進行頻譜劃分, 將整個頻率劃分為低頻中頻高頻, 每個頻帶中選擇較強的峰值.

進行頻譜過濾之後, 提取出頻譜圖中能量較強的特徵點, 記錄下歌曲ID, 出現時間, 頻率等信息作為歌曲的音頻指紋, 每秒提取出若干個這樣的音頻指紋, 就可以在數據庫中匹配音樂.