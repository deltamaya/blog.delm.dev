---
title: YUV 顏色模型
date: 2024-09-21
tags: ['圖形', '媒體處理']
authors: ['Maya']
ai: true
---

**YCbCr 顏色空間**，通常稱為 **YUV 顏色空間**，是一個用於數位電視的顏色空間。它在 ITU-R BT.601、BT.709 和 BT.2020 標準中有明確定義，分別針對標準定義、高解析度和超高解析度的數位電視。

**Y 代表亮度，而 Cb (U) 和 Cr (V) 代表色度，描述顏色的色相與飽和度。**
在此，**Cr 反映了 RGB 的紅色分量與 Y 亮度值之間的差異**，而 **Cb 反映了藍色分量與亮度值之間的差異**。在廣播電視中，使用 YCbCr 有助於解決黑白電視與彩色電視之間的訊號相容性問題。

由於人眼對 **色度的變化比亮度的變化不那麼敏感**，因此 Cb 和 Cr 通道的取樣頻率可以降低，而不會顯著影響影像品質。這樣有效地壓縮了 Cb 和 Cr 通道的數據，讓影像數據佔用更少的空間。常見的 YCbCr 取樣頻率格式包括：

- 4:4:0，每個像素平均 3 字節
- 4:2:2，每個像素平均 2 字節
- 4:2:0，每個像素平均 1.5 字節
  ![yuv-intro](/media-processing/yuv-intro.png)

### YUV444

YUV 4:4:4 與 RGB 圖像保持相同的儲存格式，Y、U 和 V 分量按順序儲存，如下圖所示。
![yuv-layout](/media-processing/yuv-layout.png)

---

YUV 格式有三種主要類型：

1. **平面格式**：在此格式中，所有 Y 像素數據會連續儲存，接著是所有 U 像素數據，然後是所有 V 像素數據。
2. **半平面格式**：在此 YUV 格式中，Y 分量單獨儲存，而 U 和 V 分量則交錯儲存。
3. **打包格式**：在此格式中，每個像素的 Y、U 和 V 值交錯儲存。

註：這裡的“連續儲存”是指整個影像的連續儲存，而不是單一像素行內的連續儲存。例如，在本文描述的 out444.yuv 圖像中，大小為 16875 KB，前 5625 字節對應 Y 數據，接下來的 5625 字節對應 U 數據，依此類推。

以下 `FFmpeg` 命令將 `jpeg` 圖像轉換為 `yuv` 格式，使用 `yuv444p` 規範，其中 `p` 代表 `平面格式`。我們專注於 **平面格式**。
在 YUV 圖像中，像素的儲存順序從左上角到右下角。因此，若要將左上角的三個像素變為白色，只需要將前三個字節從 0 改為 255。Y 代表亮度，最亮的值即為白色。如圖所示：
![](/media-processing/yuv-edit.png)
打開影像後，您會注意到左上角的三個像素已經變為白色。
![](/media-processing/yuv-edit-demo.png)

---

將 YUV 轉換為 RGB 時，必須知道 Y、U 和 V 的值。由於 U 和 V 的值被減半，我們該如何區分它們呢？

在這種情況下，第一個像素與第二個像素共享一組 UV 值。值得注意的是，在 422 格式中，U 值是從第一個和第二個像素的 U 值相加後除以 2 得到的平均值。因此，在 422 格式中，UV 值實際上是平均值。

因此，在 422 格式中，第一個和第二個像素共享一組 UV 值，第三個和第四個像素共享另一組 UV 值，以此類推，如下圖所示：

![]()

![](https://ffmpeg.xianwaizhiyin.net/base-knowledge/raw-yuv-data/raw-yuv-data-1-9.png)

上述圖像中的空白方塊表示不佔用的空間；它們僅用於說明。另外，所示的儲存順序不是平面格式，而是為了理解而包含的。

計算上述圖像中的方塊數量（不包括空白的），你會發現 YUV422 的方塊數量確實比 YUV444 少了三分之一。

### YUV420

YUV420 格式需要最少的數據，這使得它成為視頻會議、數位電視和 DVD 等應用中最常用的格式。見下圖：

![](https://ffmpeg.xianwaizhiyin.net/base-knowledge/raw-yuv-data/raw-yuv-data-1-10.png)

從圖中可以看出，第一行中的前兩個像素和第二行中的前兩個像素共享一組 UV 值，依此類推。為什麼第一行中的前四個像素不共享一組 UV 值呢？因為空間距離太遠會導致視覺效果不佳。跨行共享 UV 可確保空間距離較短，從而實現更自然的影像過渡。

這些 UV 值是通過將前四個像素的 U 值相加並除以四來計算的新平均值。

實際上，有幾種算法可以獲得 UV 值：

1. 平均值：將四個像素的 U 值相加並除以四。
2. 加權：例如，給第一兩個像素的 U 值賦予更大的權重，同時減小最後兩個像素的權重。
3. 直接丟棄第二、第三和第四個像素的 U 值，只取第一個像素的 U 值，V 值同樣如此。

其中，**取平均值**更為可靠，FFmpeg 的代碼也使用此算法來決定是取平均值還是加權。

## RGB 與 YUV 之間的轉換

RGB 顏色模型與 YUV 顏色模型之間的轉換是可行的，並由 **BT.2020 標準——超高解析度電視（UHDTV）** 標準中的公式規範：

$$
\begin{bmatrix}
R \\
G \\
B
\end{bmatrix}
=
\begin{bmatrix}
1&0&1.4746\\
1&-0.16455312684366&-0.57135312684366\\
1&1.8814&0
\end{bmatrix}
\begin{bmatrix}
Y' \\
C_B \\
C_R
\end{bmatrix}
$$

## 實作練習

我將首先使用以下命令將同一影像轉換為 YUV444、YUV422 和 YUV420 格式：

```
ffmpeg -i .\275386.jpg -s 3200*1800 -pix_fmt yuv444p out444.yuv
ffmpeg -i .\275386.jpg -s 3200*1800 -pix_fmt yuv422p out422.yuv
ffmpeg -i .\275386.jpg -s 3200*1800 -pix_fmt yuv420p out420.yuv
```

這將把一張 3200\*1800 的 JPG 圖像轉換為三個 YUV 圖像，並讓我們比較它們。
首先，讓我們來看看它們的大小：

### YUV422 檔案資訊

![yuv422-info](/media-processing/yuv422-info.png)

### YUV444 檔案資訊

![yuv444-info](/media-processing/yuv444-info.png)

顯然，YUV420 的大小是 YUV444 的一半。
接下來，讓我們比較一下清晰度：

### YUV422 圖像

![yuv422-demo](/media-processing/yuv422-demo.png)

### YUV444 圖像

![yuv444-demo](/media-processing/yuv444-demo.png)

觀察後，我們可以得出結論，這兩張圖像並沒有顯著差異。換句話說，YUV420 使用了 YUV444 一半的數據，但視覺效果幾乎沒有變化。

由於大多數視頻編碼使用 YUV420，因此當我們提到視頻解析度時，通常指的是其 **亮度解析度**，因為只有亮度是完全填充的，而 UV 則不是。

YUV 格式的檔案與 BMP 檔案相比，更準確地描述為原始數據檔案，因為它們甚至不存儲影像的寬度和高度，只忠實地記錄像素信息。因此，如果你不知道 YUV 圖像的寬度、高度和取樣格式，你將無法正確打開該圖像。

因此，除了原始像素數據外，YUV 圖像檔案不包含任何額外的資訊。由於 4:4:4 使用與 RGB24 相同的結構，每個像素佔用 3 字節，對於一個 $3200*1800$ 的影像，這個 YUV 圖像的大小計算公式如下：

$$
size=height*width*3
$$ 因此，`out444.yuv` 圖像的總大小為 $3200*1800*3=16875Kb~=16.47Mb$。
$$
